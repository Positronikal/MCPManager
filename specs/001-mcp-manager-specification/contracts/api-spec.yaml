openapi: 3.0.3
info:
  title: MCP Manager API
  description: |
    Backend API for MCP Manager - Cross-Platform Server Management Application.
    This API follows an API-first architecture, decoupling server management logic from the GUI.
  version: 1.0.0
  contact:
    name: MCP Manager Development
  license:
    name: Project License
    url: https://github.com/your-org/mcpmanager

servers:
  - url: http://localhost:8080/api/v1
    description: Local backend API server

tags:
  - name: discovery
    description: Server discovery operations
  - name: lifecycle
    description: Server lifecycle management (start/stop/restart)
  - name: configuration
    description: Server configuration management
  - name: monitoring
    description: Monitoring, logs, and metrics
  - name: dependencies
    description: Dependency checking and management
  - name: application
    description: Application state and preferences

paths:
  # ============================================================================
  # DISCOVERY ENDPOINTS
  # ============================================================================

  /servers:
    get:
      summary: List all discovered servers
      description: Retrieve list of all MCP servers discovered by the system (FR-001, FR-002)
      tags: [discovery]
      parameters:
        - name: status
          in: query
          description: Filter by server status
          schema:
            type: string
            enum: [stopped, starting, running, error]
        - name: source
          in: query
          description: Filter by discovery source
          schema:
            type: string
            enum: [client_config, filesystem, process]
      responses:
        '200':
          description: List of servers
          content:
            application/json:
              schema:
                type: object
                properties:
                  servers:
                    type: array
                    items:
                      $ref: '#/components/schemas/MCPServer'
                  count:
                    type: integer
                    description: Total number of servers
                  lastDiscovery:
                    type: string
                    format: date-time
                    description: Timestamp of last discovery scan
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/discover:
    post:
      summary: Trigger manual server discovery
      description: Manually initiate server discovery scan (FR-006)
      tags: [discovery]
      responses:
        '202':
          description: Discovery initiated (asynchronous)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Discovery scan initiated"
                  scanId:
                    type: string
                    format: uuid
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}:
    get:
      summary: Get server details
      description: Retrieve detailed information about a specific server
      tags: [discovery]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Server details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPServer'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # LIFECYCLE ENDPOINTS
  # ============================================================================

  /servers/{serverId}/start:
    post:
      summary: Start a server
      description: Launch a stopped server process (FR-007, FR-052)
      tags: [lifecycle]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '202':
          description: Server start initiated (asynchronous)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Server starting"
                  serverId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [starting]
        '400':
          description: Bad request (e.g., server already running)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}/stop:
    post:
      summary: Stop a server
      description: Terminate a running server process (FR-008)
      tags: [lifecycle]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                force:
                  type: boolean
                  description: Force kill if graceful shutdown fails
                  default: false
                timeout:
                  type: integer
                  description: Graceful shutdown timeout in seconds
                  default: 10
      responses:
        '202':
          description: Server stop initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Server stopping"
                  serverId:
                    type: string
                    format: uuid
        '400':
          description: Bad request (e.g., server not running)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}/restart:
    post:
      summary: Restart a server
      description: Stop and start a server (FR-009)
      tags: [lifecycle]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '202':
          description: Server restart initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Server restarting"
                  serverId:
                    type: string
                    format: uuid
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}/status:
    get:
      summary: Get server status
      description: Retrieve current operational status (FR-005)
      tags: [lifecycle]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Server status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerStatus'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # CONFIGURATION ENDPOINTS
  # ============================================================================

  /servers/{serverId}/configuration:
    get:
      summary: Get server configuration
      description: Retrieve server-specific configuration (FR-014, FR-015)
      tags: [configuration]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Server configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerConfiguration'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update server configuration
      description: Modify server-specific configuration (FR-016, FR-017, FR-018)
      tags: [configuration]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServerConfiguration'
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerConfiguration'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # MONITORING ENDPOINTS
  # ============================================================================

  /servers/{serverId}/logs:
    get:
      summary: Get server logs
      description: Retrieve log entries for a server (FR-024)
      tags: [monitoring]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
        - name: severity
          in: query
          description: Filter by log severity
          schema:
            type: string
            enum: [info, success, warning, error]
        - name: limit
          in: query
          description: Maximum number of entries (max 1000 per FR-053)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Log entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogEntry'
                  total:
                    type: integer
                    description: Total log entries for this server
                  hasMore:
                    type: boolean
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /logs:
    get:
      summary: Get all logs (filtered)
      description: Retrieve logs from all servers with filtering (FR-022, FR-023)
      tags: [monitoring]
      parameters:
        - name: serverId
          in: query
          description: Filter by server ID
          schema:
            type: string
            format: uuid
        - name: severity
          in: query
          description: Filter by severity
          schema:
            type: string
            enum: [info, success, warning, error]
        - name: search
          in: query
          description: Search in log messages
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Filtered log entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogEntry'
                  total:
                    type: integer
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}/metrics:
    get:
      summary: Get server metrics
      description: Retrieve health metrics (FR-025, FR-026)
      tags: [monitoring]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Server metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  uptimeSeconds:
                    type: integer
                    nullable: true
                  memoryUsageMB:
                    type: number
                    format: float
                    nullable: true
                  requestCount:
                    type: integer
                    nullable: true
                  cpuPercent:
                    type: number
                    format: float
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # DEPENDENCY ENDPOINTS
  # ============================================================================

  /servers/{serverId}/dependencies:
    get:
      summary: Check server dependencies
      description: Retrieve dependency status (FR-027, FR-028)
      tags: [dependencies]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Dependency status
          content:
            application/json:
              schema:
                type: object
                properties:
                  dependencies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Dependency'
                  allSatisfied:
                    type: boolean
                    description: True if all dependencies are installed
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /servers/{serverId}/updates:
    get:
      summary: Check for server updates
      description: Check if newer version available (FR-029)
      tags: [dependencies]
      parameters:
        - $ref: '#/components/parameters/ServerIdParam'
      responses:
        '200':
          description: Update status
          content:
            application/json:
              schema:
                type: object
                properties:
                  updateAvailable:
                    type: boolean
                  currentVersion:
                    type: string
                  latestVersion:
                    type: string
                  releaseNotes:
                    type: string
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # APPLICATION STATE ENDPOINTS
  # ============================================================================

  /application/state:
    get:
      summary: Get application state
      description: Retrieve persisted application state (FR-041)
      tags: [application]
      responses:
        '200':
          description: Application state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplicationState'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update application state
      description: Persist application state changes (FR-041)
      tags: [application]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplicationState'
      responses:
        '200':
          description: State updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Application state saved"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # EVENTS (SSE - Server-Sent Events)
  # ============================================================================

  /events:
    get:
      summary: Subscribe to real-time events
      description: |
        Server-Sent Events (SSE) stream for real-time updates (FR-005, FR-047).
        
        **Connection Management**:
        - Client establishes persistent HTTP connection
        - Server sends events as they occur (no polling)
        - Connection kept alive with periodic heartbeat comments
        - Automatic reconnection on disconnect (client responsibility)
        
        **Reconnection Strategy**:
        1. Client detects disconnect (connection close, timeout, error)
        2. Client waits exponential backoff: 1s, 2s, 4s, 8s (max 30s)
        3. Client reconnects with `Last-Event-ID` header if available
        4. Server resends missed events based on `Last-Event-ID`
        5. If `Last-Event-ID` unknown, server sends full state snapshot
        
        **Event Format**:
        ```
        id: <event-uuid>
        event: <event-type>
        data: <json-payload>
        
        ```
        
        **Heartbeat**:
        - Server sends `: heartbeat` comment every 15s to keep connection alive
        - Client should close + reconnect if no data received for 45s
      tags: [monitoring]
      parameters:
        - name: serverIds
          in: query
          description: Comma-separated server IDs to monitor (empty = all servers)
          schema:
            type: string
            example: "uuid1,uuid2"
        - name: Last-Event-ID
          in: header
          required: false
          description: Last received event ID for reconnection resume
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Event stream established
          headers:
            Content-Type:
              schema:
                type: string
                enum: [text/event-stream]
            Cache-Control:
              schema:
                type: string
                enum: [no-cache]
            Connection:
              schema:
                type: string
                enum: [keep-alive]
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSE stream with event types:
                  
                  **ServerDiscovered**
                  ```json
                  {
                    "id": "<event-uuid>",
                    "type": "ServerDiscovered",
                    "timestamp": "2025-10-15T14:30:00Z",
                    "data": {
                      "serverId": "<server-uuid>",
                      "name": "filesystem",
                      "source": "client_config"
                    }
                  }
                  ```
                  
                  **ServerStatusChanged**
                  ```json
                  {
                    "id": "<event-uuid>",
                    "type": "ServerStatusChanged",
                    "timestamp": "2025-10-15T14:30:00Z",
                    "data": {
                      "serverId": "<server-uuid>",
                      "previousState": "stopped",
                      "newState": "running",
                      "pid": 12345
                    }
                  }
                  ```
                  
                  **ServerLogEntry**
                  ```json
                  {
                    "id": "<event-uuid>",
                    "type": "ServerLogEntry",
                    "timestamp": "2025-10-15T14:30:00Z",
                    "data": {
                      "serverId": "<server-uuid>",
                      "severity": "info",
                      "message": "Server started successfully"
                    }
                  }
                  ```
                  
                  **ConfigFileChanged**
                  ```json
                  {
                    "id": "<event-uuid>",
                    "type": "ConfigFileChanged",
                    "timestamp": "2025-10-15T14:30:00Z",
                    "data": {
                      "filePath": "~/.config/Claude/claude_desktop_config.json",
                      "changeType": "modified"
                    }
                  }
                  ```
                  
                  **ServerMetricsUpdated**
                  ```json
                  {
                    "id": "<event-uuid>",
                    "type": "ServerMetricsUpdated",
                    "timestamp": "2025-10-15T14:30:00Z",
                    "data": {
                      "serverId": "<server-uuid>",
                      "uptimeSeconds": 120,
                      "memoryUsageMB": 45.3,
                      "requestCount": 15
                    }
                  }
                  ```
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

# ============================================================================
# COMPONENTS
# ============================================================================

components:
  parameters:
    ServerIdParam:
      name: serverId
      in: path
      required: true
      description: Server UUID
      schema:
        type: string
        format: uuid

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    MCPServer:
      type: object
      required:
        - id
        - name
        - installationPath
        - status
        - configuration
        - discoveredAt
        - lastSeenAt
        - source
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          minLength: 1
          maxLength: 100
        version:
          type: string
          nullable: true
        installationPath:
          type: string
        status:
          $ref: '#/components/schemas/ServerStatus'
        pid:
          type: integer
          nullable: true
        capabilities:
          type: array
          items:
            type: string
          nullable: true
        tools:
          type: array
          items:
            type: string
          nullable: true
        configuration:
          $ref: '#/components/schemas/ServerConfiguration'
        dependencies:
          type: array
          items:
            $ref: '#/components/schemas/Dependency'
        discoveredAt:
          type: string
          format: date-time
        lastSeenAt:
          type: string
          format: date-time
        source:
          type: string
          enum: [client_config, filesystem, process]

    ServerStatus:
      type: object
      required:
        - state
        - lastStateChange
        - startupAttempts
      properties:
        state:
          type: string
          enum: [stopped, starting, running, error]
        uptimeSeconds:
          type: integer
          nullable: true
        memoryUsageMB:
          type: number
          format: float
          nullable: true
        requestCount:
          type: integer
          nullable: true
        lastStateChange:
          type: string
          format: date-time
        errorMessage:
          type: string
          maxLength: 500
          nullable: true
        startupAttempts:
          type: integer
          minimum: 0

    ServerConfiguration:
      type: object
      required:
        - autoStart
        - restartOnCrash
        - maxRestartAttempts
      properties:
        environmentVariables:
          type: object
          additionalProperties:
            type: string
          nullable: true
        commandLineArguments:
          type: array
          items:
            type: string
          nullable: true
        workingDirectory:
          type: string
          nullable: true
        autoStart:
          type: boolean
          default: false
        restartOnCrash:
          type: boolean
          default: false
        maxRestartAttempts:
          type: integer
          minimum: 0
          maximum: 10
          default: 3
        configFilePath:
          type: string
          nullable: true
        customCommand:
          type: string
          maxLength: 500
          nullable: true

    LogEntry:
      type: object
      required:
        - id
        - timestamp
        - severity
        - source
        - message
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        severity:
          type: string
          enum: [info, success, warning, error]
        source:
          type: string
          description: Server ID or "mcpmanager"
        message:
          type: string
          maxLength: 10000
        metadata:
          type: object
          additionalProperties: true
          nullable: true

    Dependency:
      type: object
      required:
        - id
        - name
        - type
        - installed
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 100
        type:
          type: string
          enum: [runtime, library, tool, environment]
        requiredVersion:
          type: string
          nullable: true
        detectedVersion:
          type: string
          nullable: true
        installed:
          type: boolean
        installationInstructions:
          type: string
          maxLength: 1000
          nullable: true
        checkCommand:
          type: string
          nullable: true

    ApplicationState:
      type: object
      required:
        - discoveredServers
        - userPreferences
        - windowLayout
        - selectedFilters
        - lastDiscoveryTimestamp
        - monitoredConfigPaths
      properties:
        discoveredServers:
          type: array
          items:
            type: string
            format: uuid
        userPreferences:
          $ref: '#/components/schemas/UserPreferences'
        windowLayout:
          $ref: '#/components/schemas/WindowLayout'
        selectedFilters:
          $ref: '#/components/schemas/Filters'
        lastDiscoveryTimestamp:
          type: string
          format: date-time
        monitoredConfigPaths:
          type: array
          items:
            type: string

    UserPreferences:
      type: object
      properties:
        theme:
          type: string
          enum: [dark, light, system]
          default: dark
        logRetentionPerServer:
          type: integer
          default: 1000
        autoRefreshDiscovery:
          type: boolean
          default: false
        showSystemNotifications:
          type: boolean
          default: true
        confirmServerStop:
          type: boolean
          default: true

    WindowLayout:
      type: object
      properties:
        width:
          type: integer
          minimum: 640
          default: 1280
        height:
          type: integer
          minimum: 480
          default: 800
        x:
          type: integer
        y:
          type: integer
        maximized:
          type: boolean
          default: false
        logPanelHeight:
          type: integer
          default: 200

    Filters:
      type: object
      properties:
        selectedServer:
          type: string
          format: uuid
          nullable: true
        selectedSeverity:
          type: string
          enum: [info, success, warning, error]
          nullable: true
        searchQuery:
          type: string
          default: ""

    Error:
      type: object
      required:
        - message
        - code
      properties:
        message:
          type: string
        code:
          type: string
        details:
          type: object
          additionalProperties: true
          nullable: true
